
### 그라나도 사전예약 건(~7월 초)

그라나도 사전예약 7월 초
- 모바일 / 홈페이지 따로 진행예정
- 기존 사전가입 레퍼런스 많아서 참고 ㄱㄱ
- 프론트만 보면됨

1. 그라나도 사전가입
[https://qa.mangot5.com/game/ge/preSignup/index](https://qa.mangot5.com/game/ge/preSignup/index "https://qa.mangot5.com/game/ge/presignup/index")

2. 레퍼런스 cls 사전가입 
[https://qa.mangot5.com/game/cls/preSignup/index](https://qa.mangot5.com/game/cls/preSignup/index "https://qa.mangot5.com/game/cls/presignup/index")

jcgf 구조 분석
- 프론트는 주로 그대로 따라감

duplicate line or selection

## [✅사전가입페이지 기능별 정리](https://dev.azure.com/jeffkang/ht-devOps/_wiki/wikis/ht-devOps.wiki/1041/1.-%EC%82%AC%EC%A0%84%EA%B0%80%EC%9E%85-%ED%8E%98%EC%9D%B4%EC%A7%80-%EC%A0%95%EB%A6%AC%EC%A4%91)

## [✅ 사전예약정리_연상님](https://dev.azure.com/jeffkang/ht-devOps/_wiki/wikis/ht-devOps.wiki/1606)

## [✅ 사전가입프로세스_승민님](https://dev.azure.com/jeffkang/ht-devOps/_wiki/wikis/ht-devOps.wiki/909)



****

### 사전예약 Flow

#### >> 📤url 입력 후

1. qa.mangot5.com/game/cls/preSignup/index url 입력
   **game/게임명/preSignup/index 페이지 get 호출**

2. Event.preSignup()에서 Get매핑으로 받아옴 / 주소에서 gname 추출
```
@RequestMapping(value = { "/{gname}/preSignup/index", "/{gname}/preReservation/index" } , method = RequestMethod.GET)  
public abstract ModelAndView preSignup(@PathVariable String gname, HttpServletRequest request) throws Exception;
```

 2-1. Event class 자손 EventController 클래스에서 오버라이딩한 preSignup()로 이동(line 1322)
```
@Override  
public ModelAndView preSignup(@PathVariable String gname, HttpServletRequest request) throws Exception {
....(역사)
```

----
### >> at EventController


request session에 specialEvent 속성 없으면 specialEvent 0, 있으면 1
```
//사전가입이 아닌 이벤트 페이지를 위한 분기처리용 value
Boolean specialEvent = StringUtils.isNotEmpty((String) request.getAttribute("specialEvent"));
```

redis CONFIG_TW_TEST / {gname}_preSignup 연결되어 경로를 REDIS_PREFIX_KEY에 저장(이게 redis_name)
(LIVE인 경우엔 CONFIG_TW_LIVE로!)
```
String REDIS_PREFIX_KEY = specialEvent ? UtilRedis.CONFIG_SUBFIX + gname + "_specialEvent" :  UtilRedis.CONFIG_SUBFIX + gname + "_preSignup";
```

redis 해당 경로 내의 Hash 정보 중 Field명이 event_id이고 Value의 key값이 value인 v 값을 찾아 redisEventCode에 저장 -> eventCode로 옮김
```
String redisEventCode = redisService.getRedisTargetKeyData(REDIS_PREFIX_KEY, "event_id","value");
```

eventCode 들고 service -> DAO 호출
```
Integer totalJoin      = preregisterInviteService.pre_SignupcountAll(eventCode);
```

연결되는 sql mapper : preregisterinvite.xml / 여기서 해당 eventCode로 참여한 참가자 수를 반환 -> controller의 totalJoin 변수에 값 저장
```
<select id="PreSignup_getPreregisterInvitCountByEventCode" parameterClass="str" resultClass="int">  
     SELECT count(1) as cnt FROM preregister_invite_withoutfb WHERE event_code = #event_code#   
</select>
```

{gname}yeri_preSignup 형식으로 view의 vieName에 저장
```
} else {  
   view = new ModelAndView(gname+characterName+"_preSignup");  
}
```

session에서 로그인정보를 (Map)user에 저장
```
// 사전예약 했는지 여부 조회  
Map user = (Map) request.getSession().getAttribute("user");
```

로그인되었다면 ) DB에 사전가입 이력이 있으면 preregisterInviteService = 1, 아니면 0
```
int platformLoginOrRefreshCheck = 0;  
if (user != null && "lostark".equals(gname)) {  
   String email = (String) user.get("email");  
   platformLoginOrRefreshCheck = preregisterInviteService.prelogin_checkEmailExists(eventCode, email) ? 1 : 0;  
}
```

boost 등록을 해놓은 게임인지 확인하고 isUseBoostGameFromDb 에 T/F 저장
(군디 redis에 fielName의 정보가 없음... 머지... 할떄마다 새로 입력하는곤가)
```
String redisBoostGameFromDb = redisService.getRedisTargetKeyData(REDIS_PREFIX_KEY, "isUseBoostGameFromDb","value");  
//TODO add game boost use by jcgf.PreRegisterBoost  
  
boolean isUseBoostGameFromDb = Boolean.parseBoolean(StringUtils.isNotEmpty(redisBoostGameFromDb) ? redisBoostGameFromDb : env.getProperty(MODE+"."+pgname+characterName+".preRegistInvite.isUseBoostGameFromDb"));
```

isUseBoostGameFromDb은 고검기담때만 사용 ㅋ 하고 gname으로 if문 분기들어감
if문 들어가기 전 setLoginUserInfo() 호출
```
setLoginUserInfo(request, view, eventCode);
```

eventcontroller.setLoginUserInfo()에서 
user가 event에 참여했는지 확인하고 그외 계정 정보를 view에 저장
```
if(user!= null)
boolean regist = preregisterInviteService.checkUserIDExists(eventCode, userID);
```

gname으로 if분기 ㄱㄱ
```
if("gj".equals(gname)){  
   if(specialEvent){  
      ....  
   }else{  
      String event1 = redisService.getRedisTargetKeyData(REDIS_PREFIX_KEY, "event_url","event1");
      ...  
      String downloadStartDate = redisService.getRedisTargetKeyData(REDIS_PREFIX_KEY, "download_start", "value");  
  
      view.addObject("event1", event1);  
      view.addObject("event2", event2);  
      view.addObject("event3",event3);  
      view.addObject("downloadStartDate", downloadStartDate);  
   }  
  
}
```

요약 : EventController.preSignup()에서 로그인정보(미로그인시 입력값없음)와 setting 된 redis 세팅 값을 view에 저장해 index로 전달


----

### >> view 연결

3. src/com/jc/view/template-promotion.xml 에 연결될 index 페이지 입력 (tiles 사용해서 조각조각땃땃따)
```
<definition name="gj_preSignup" template="/WEB-INF/jsp/promotion/preRegistInvite/gj/index.jsp" preparer="gamePrepare"/>
```


4. EventController에서 view에 저장된 viewname이 일치하는 경로(위 코드 중 definition name에 해당)를 template-@.xml에서 찾아 연결
 - view resolver 설정 : dispatcher-servlet.xml 의 tilesConfigurer에서 연결설정
```
<bean id="tilesConfigurer" class="org.springframework.web.servlet.view.tiles3.TilesConfigurer">  
   <property name="definitions">       
      <list>  
         <value>classpath:/com/jc/view/template-*.xml</value>  
      </list>   </property>      
<property name="preparerFactoryClass" value="org.springframework.web.servlet.view.tiles3.SpringBeanPreparerFactory" />   
<property name="completeAutoload" value="false"/>  
</bean>
```
✅ [[tilesConfigurer 설명]]


5. WebContent/WEB-INF/jsp/promotion/preRegistInvite/{게임명}/index.jsp 에서 화면구현


#### 💻>>화면 로딩 후


at index.jsp
step 1 - 로그인 여부에 따라 화면로딩 change (미로그인 : 로그인/회원가입 | 로그인 : 로그아웃)
```
<div class="step1">  
  <!---------------------未登入------------------------->   
  <c:if test="${empty sessionScope.user}">
  ...
  <!---------------------已登入------------------------->  
  <c:if test="${not empty sessionScope.user}">
  
```
아니근데 여기 contextPath가머야대체,,, -> 거쳐가는 tiles 파일 먼저 찾아보기!


step2 - 사전예약 참가신청 -> 버튼 클릭시 Signup() script 함수 작동
```
<!---========================step2==============================--->  
<div class="step2">  
   <a href="#" class="btn2 signbtn btn04" id="loginBtn" onclick="Signup()" name="事前登錄按鈕"></a>  
</div>
```




4. 해당 페이지에서 로그인 시 로그인 후 
`<img src="//landing.mangot5.com/template/cls/event/211111_lucy/image/galaxy_sign1.png" alt="로그인" onclick="window.location.href='/Index/Member/Login?ref=/game/cls/preSignup/index'"`

사전예약 페이지로 리다이렉트됨.

리다이렉트되기 전~~~~


- 로그인 클릭 시 작동 함수는 index.jsp 파일 하단 script로 function Signup() 에 적혀있음

- 위 함수에서 로그인 정보 가공해서 
	Events.java의 (138line) /game/ge/preSignup/send.json 로 post 요청함(비동기)
	해당 메서드는 **EventsController.java에 상속됨 (line 581)**
		redis를 사용하는 값이 없으면 env에 설정한 값으로 설정됨.
		#바꿀부분 line623 / gname.equals("게임명")
		- **PreregisterInviteService 서비스(bean) 호출해서 validateUserData 메서드** 호출.(line404)
			#바꿀부분 line419(PreregisterInviteService.java) gname / line447 / line496
			- 여기서 수많은 에러조건들 통과하면 **PreregisterInviteService.doPrelogin 메서드 호출**, (line492)
			- doPrelogin 메서드 내에서 PreregisterInvite DTO생성 후 로그인정보 입력 → 이후 DAO 호출 (**preregisterInviteDao.Prelogin_insertMembersData(newObj)**), line89 → batis의 getSqlMapClientTemplate 클래스(lib) 로 **로그인 정보 DB 인서트**! : 자세한 인서트 코드는 getSqlMapClientTemplate.insert 메서드에서 화긴) → **newObj.getShare_code() 리턴**
			- 다 돌아온 후 **result에 메세지 세팅 후 리턴(PreRegistInvitePostResultVO 객체)**
	- **EventsController.java에 service에서 리턴된 result 대입 후 리턴**
	
	- 비동기응답 후 아까 비동기 호출했던 index.jsp 페이지에서 정상로그인 여부에 따라 alert띄움.


#### 마이바티스 쿼리
마이바티스 쿼리 preregister_invite_withoutfb 있는 xml 은 preregisterInvite.xml 에 있습니다

최근 소호강호 라는 게임이 오픈했을 떄 했던 사전예약 조회인데 이거 보시면 될 거 같습니다.
```
select_ * _from_ preregister_invite_withoutfb _where_ gname = 'xa' _order by_ data_created _desc;
```


## Q. 

~~1. 그럼 jsgf는 redis를 DB처럼 쓰는건가...?
~~-> jcgf DB 따로 씁니당!
**jcgf_qa 중 preregister_invite_withoutfb 테이블에서 확인가능**

2. 인텔리제이에 git 연결하는게 그럼 한 컴퓨터에서는 계정을 하나만 쓸 수 있는곤가,,,?
3. jcgf 폴더에 /out 폴더는 뭐하는데지,,?
4. 


### (진행후)사전가입 데이터 추출(사업팀 보고용)
[[가입 데이터 추출 페이지 추가(사업팀 보고용)]]



0508 체크중
-EventsController 마지막에서부터 올라가면서 보는중. 1507line 확인중! (승민님 위키 보면서~)